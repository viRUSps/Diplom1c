

Процедура ВыполнитьСозданиеРеализацийВФоне(Параметры) Экспорт
	
	НачалоМесяца = НачалоМесяца(Параметры.Период);
	КонецМесяца  = КонецМесяца(Параметры.Период);
	
	ТаблицаРезультатов = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Реализация.ДоговорКонтрагента КАК Договор,
		|	МАКСИМУМ(Реализация.Ссылка) КАК Ссылка
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК Реализация
		|ГДЕ
		|	Реализация.ДоговорКонтрагента В(&Договоры)
		|	И Реализация.Дата МЕЖДУ &НачалоМесяца И &КонецМесяца
		|	И НЕ Реализация.ПометкаУдаления
		|СГРУППИРОВАТЬ ПО
		|	Реализация.ДоговорКонтрагента";
	
	Запрос.УстановитьПараметр("Договоры",      Параметры.Договоры);
	Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца);
	Запрос.УстановитьПараметр("КонецМесяца",  КонецМесяца);
	
	ТаблицаСуществующих = Запрос.Выполнить().Выгрузить();
	ТаблицаСуществующих.Индексировать("Договор");
	
	Для Каждого ТекущийДоговор Из Параметры.Договоры Цикл
		
		СтрокаСуществующего = ТаблицаСуществующих.Найти(ТекущийДоговор, "Договор");
		
		Если СтрокаСуществующего <> Неопределено Тогда
			ТаблицаРезультатов.Добавить(Новый Структура("Договор, Реализация", ТекущийДоговор, СтрокаСуществующего.Ссылка));
			Продолжить;
		КонецЕсли;
		
		НовыйДокумент = Документы.РеализацияТоваровУслуг.СоздатьДокумент();
		НовыйДокумент.Дата                = КонецМесяца;
		НовыйДокумент.Организация         = ТекущийДоговор.Организация;
		НовыйДокумент.Контрагент          = ТекущийДоговор.Владелец;
		НовыйДокумент.ДоговорКонтрагента  = ТекущийДоговор;
		
		НовыйДокумент.Заполнить(ТекущийДоговор);
		НовыйДокумент.ВыполнитьАвтозаполнение();
		
		Если НовыйДокумент.ПроверитьЗаполнение() Тогда
			Попытка
				НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
				ТаблицаРезультатов.Добавить(Новый Структура("Договор, Реализация", ТекущийДоговор, НовыйДокумент.Ссылка));
			Исключение
				ТаблицаРезультатов.Добавить(Новый Структура("Договор, Реализация", ТекущийДоговор, Неопределено));
			КонецПопытки;
		Иначе
			ТаблицаРезультатов.Добавить(Новый Структура("Договор, Реализация", ТекущийДоговор, Неопределено));
		КонецЕсли;
		
	КонецЦикла;
	
	АдресРезультата = ПоместитьВоВременноеХранилище(ТаблицаРезультатов);
КонецПроцедуры  


Функция ВыполнитьСозданиеРеализацийНаСервере(Параметры) Экспорт
	
	НачалоМесяца = НачалоМесяца(Параметры.Период);
    КонецМесяца  = КонецМесяца(Параметры.Период);
    ТекущийПользователь = Пользователи.ТекущийПользователь();
    
    ТаблицаРезультатов = Новый Массив;
    
    ЗапросСуществующих = Новый Запрос;
    ЗапросСуществующих.Текст = 
        "ВЫБРАТЬ
        |   Реализация.Договор КАК Договор,
        |   Реализация.Ссылка КАК Ссылка
        |ИЗ
        |   Документ.РеализацияТоваровУслуг КАК Реализация
        |ГДЕ
        |   Реализация.Договор В (&СписокДоговоров)
        |   И Реализация.Дата МЕЖДУ &НачалоМесяца И &КонецМесяца
        |   И НЕ Реализация.ПометкаУдаления";
    
    ЗапросСуществующих.УстановитьПараметр("СписокДоговоров", Параметры.Договоры);
    ЗапросСуществующих.УстановитьПараметр("НачалоМесяца", НачалоМесяца);
    ЗапросСуществующих.УстановитьПараметр("КонецМесяца", КонецМесяца);
    
    Выборка = ЗапросСуществующих.Выполнить().Выбрать();
    
    СоответствиеСуществующих = Новый Соответствие;
    Пока Выборка.Следующий() Цикл
        СоответствиеСуществующих.Вставить(Выборка.Договор, Выборка.Ссылка);
    КонецЦикла;

    Для Каждого ТекущийДоговор Из Параметры.Договоры Цикл
        
        СуществующаяРеализация = СоответствиеСуществующих.Получить(ТекущийДоговор);
        
        Если СуществующаяРеализация <> Неопределено Тогда
            ТаблицаРезультатов.Добавить(Новый Структура("Договор, Реализация", ТекущийДоговор, СуществующаяРеализация));
            Продолжить;
        КонецЕсли;
        
        НовыйДокумент = Документы.РеализацияТоваровУслуг.СоздатьДокумент();
        НовыйДокумент.Дата                = КонецДня(КонецМесяца);
        НовыйДокумент.Организация         = ТекущийДоговор.Организация;
        НовыйДокумент.Контрагент          = ТекущийДоговор.Владелец;
        НовыйДокумент.Договор             = ТекущийДоговор;
        НовыйДокумент.Ответственный       = ТекущийПользователь;
        НовыйДокумент.ВыполнитьАвтозаполнение();
        
        Если НовыйДокумент.ПроверитьЗаполнение() Тогда
            Попытка
                НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
                ТаблицаРезультатов.Добавить(Новый Структура("Договор, Реализация", ТекущийДоговор, НовыйДокумент.Ссылка));
            Исключение
                ТаблицаРезультатов.Добавить(Новый Структура("Договор, Реализация", ТекущийДоговор, Неопределено));
            КонецПопытки;
        Иначе
            ТаблицаРезультатов.Добавить(Новый Структура("Договор, Реализация", ТекущийДоговор, Неопределено));
        КонецЕсли;
        
    КонецЦикла;
    
    Возврат ТаблицаРезультатов;
	
	
КонецФункции
	
